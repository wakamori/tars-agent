<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TARS - World Model Experiment</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #ffffff;
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        margin-bottom: 10px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .subtitle {
        text-align: center;
        margin-bottom: 30px;
        opacity: 0.9;
        font-size: 1.2em;
      }

      .main-content {
        display: grid;
        grid-template-columns: 600px 280px 280px;
        gap: 20px;
        align-items: start;
      }

      .simulation-panel {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      #simulation-container {
        width: 100%;
        background: #1a1a2e;
        border-radius: 10px;
        overflow: hidden;
        line-height: 0;
      }

      #simulation-container canvas {
        display: block;
        width: 100% !important;
        height: auto !important;
      }

      .control-panel {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      .level-selector {
        margin-bottom: 10px;
      }

      .level-selector h3 {
        margin-bottom: 6px;
        font-size: 1em;
      }

      .level-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }

      .level-btn {
        padding: 8px;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.85em;
      }

      .level-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .level-btn.active {
        background: rgba(255, 215, 0, 0.4);
        border-color: #FFD700;
      }

      .state-info {
        margin-bottom: 0;
      }

      .state-info h3 {
        margin-bottom: 6px;
        font-size: 1em;
      }

      .state-item {
        background: rgba(0, 0, 0, 0.2);
        padding: 6px 8px;
        border-radius: 5px;
        margin-bottom: 5px;
        font-family: 'Courier New', monospace;
        font-size: 0.85em;
      }

      .state-item:last-child {
        margin-bottom: 0;
      }

      .state-item:last-child {
        margin-bottom: 0;
      }

      .btn {
        padding: 12px;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
      }

      .btn:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn.primary {
        background: rgba(76, 175, 80, 0.6);
        border-color: #4CAF50;
        font-size: 1em;
      }

      .btn.primary:hover:not(:disabled) {
        background: rgba(76, 175, 80, 0.8);
      }

      .ai-panel {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      .ai-panel h3 {
        margin-bottom: 10px;
        font-size: 1em;
      }

      .ai-thinking-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .ai-section {
        background: rgba(0, 0, 0, 0.2);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid;
      }

      .ai-section h4 {
        margin-bottom: 6px;
        font-size: 0.9em;
      }

      .ai-content {
        font-size: 0.8em;
        line-height: 1.5;
      }

      .observation-section {
        border-left-color: #4CAF50;
      }

      .memory-section {
        border-left-color: #2196F3;
      }

      .reflection-section {
        border-left-color: #FF9800;
      }

      .planning-section {
        border-left-color: #9C27B0;
      }

      .memory-item {
        padding: 6px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.85em;
      }

      .memory-item:last-child {
        border-bottom: none;
      }

      .footer {
        margin-top: 30px;
        text-align: center;
        opacity: 0.7;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¤– TARS - World Model Experiment</h1>
      <p class="subtitle">
        LLMé§†å‹•ã®å€‰åº«ç•ªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ - ç‰©ç†æ³•å‰‡ã‚’å­¦ç¿’ã—ã€å‰µç™ºçš„ãªè§£æ±ºç­–ã‚’ç™ºè¦‹ã™ã‚‹
      </p>

      <div class="main-content">
        <!-- Simulation Canvas -->
        <div class="simulation-panel">
          <div id="simulation-container"></div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
          <!-- Level Selector -->
          <div class="level-selector">
            <h3>ğŸ“‹ ãƒ¬ãƒ™ãƒ«é¸æŠ</h3>
            <div class="level-buttons">
              <button class="level-btn active" data-level="tutorial">
                åŸºç¤ï¼šç›´ç·šç§»å‹•
              </button>
              <button class="level-btn" data-level="friction">
                ç‰©ç†ï¼šæ‘©æ“¦ä¿‚æ•°
              </button>
              <button class="level-btn" data-level="obstacle">
                éšœå®³ï¼šå£ã®å›é¿
              </button>
              <button class="level-btn" data-level="barrier">
                æˆ¦ç•¥ï¼šèª˜å°è·¯
              </button>
            </div>
          </div>

          <!-- State Info -->
          <div class="state-info">
            <h3>ğŸ“Š çŠ¶æ…‹</h3>
            <div class="state-item" id="state-position">ä½ç½®: (-, -)</div>
            <div class="state-item" id="state-velocity">é€Ÿåº¦: (-, -)</div>
            <div class="state-item" id="state-step">ã‚¹ãƒ†ãƒƒãƒ—: 0</div>
            <div class="state-item" id="state-time">æ™‚é–“: 0.0s</div>
          </div>
        </div>

        <!-- AI Mode Panel -->
        <div class="ai-panel">
            <h3>ğŸ§  AI (EP: <span id="episode-count">0</span>)</h3>
            <div style="margin-bottom: 10px;">
              <button class="btn primary" id="btn-ai-mode">
                ğŸ¤– AIé–‹å§‹
              </button>
            </div>
            
            <!-- Generative Agents Style Display -->
            <div class="ai-thinking-container">
              <!-- Observation Section -->
              <div class="ai-section observation-section">
                <h4>ğŸ‘€ è¦³å¯Ÿ</h4>
                <div id="ai-observation" class="ai-content">
                  AIãƒ¢ãƒ¼ãƒ‰: åœæ­¢ä¸­
                </div>
              </div>
              
              <!-- Memory Stream Section -->
              <div class="ai-section memory-section">
                <h4>ğŸ“š è¨˜æ†¶</h4>
                <div id="ai-memory" class="ai-content">
                  å±¥æ­´ãªã—
                </div>
              </div>
              
              <!-- Reflection Section -->
              <div class="ai-section reflection-section">
                <h4>ğŸ’­ å­¦ç¿’</h4>
                <div id="ai-reflection" class="ai-content">
                  æˆ¦ç•¥ãªã—
                </div>
              </div>
              
              <!-- Planning Section -->
              <div class="ai-section planning-section">
                <h4>ğŸ¯ è¨ˆç”»</h4>
                <div id="ai-planning" class="ai-content">
                  <strong>æ¨è«–:</strong> å¾…æ©Ÿä¸­<br/>
                  <strong>è¡Œå‹•:</strong> ãªã—
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <p>TARS Â© 2026 - LLM-driven World Model for Warehouse Simulation</p>
      </div>
    </div>

    <script type="module">
      import { WarehouseSimulation, LEVELS } from './dist/simulation.js';

      let simulation = null;
      let currentLevel = 'tutorial';
      let updateInterval = null;
      let aiMode = false;
      let aiInterval = null;
      let actionHistory = [];
      let isAIThinking = false;
      let autoRetry = true;
      let episodeCount = 0;
      let currentEpisodeReward = 0;
      let episodeTransitioning = false;

      // Initialize
      function init() {
        const container = document.getElementById('simulation-container');
        simulation = new WarehouseSimulation(container, currentLevel);
        setupEventListeners();
        startStateUpdate();
      }

      // Setup event listeners
      function setupEventListeners() {
        // Level selection
        document.querySelectorAll('.level-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            if (aiMode) return; // Prevent level change during AI mode
            
            document.querySelectorAll('.level-btn').forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
            currentLevel = btn.dataset.level;
            simulation.reset(currentLevel);
          });
        });

        // AI Mode button
        document.getElementById('btn-ai-mode').addEventListener('click', () => {
          if (aiMode) {
            stopAIMode();
          } else {
            startAIMode();
          }
        });
      }

      // Update state display
      async function updateStateDisplay() {
        const state = simulation.getState();

        document.getElementById('state-position').textContent =
          `ä½ç½®: (${state.box.position.x.toFixed(1)}, ${state.box.position.y.toFixed(1)})`;

        document.getElementById('state-velocity').textContent =
          `é€Ÿåº¦: (${state.box.velocity.x.toFixed(2)}, ${state.box.velocity.y.toFixed(2)})`;

        document.getElementById('state-step').textContent = `ã‚¹ãƒ†ãƒƒãƒ—: ${state.step}`;

        document.getElementById('state-time').textContent =
          `æ™‚é–“: ${state.elapsedTime.toFixed(1)}s`;

        // Check success/failure (only in AI mode and not already transitioning)
        if (aiMode && !episodeTransitioning) {
          if (state.isSuccess) {
            episodeTransitioning = true;
            
            // Clear existing AI loop to prevent overlap
            if (aiInterval) {
              clearTimeout(aiInterval);
              aiInterval = null;
            }
            
            // ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å®Œäº†ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€šçŸ¥
            await completeEpisode(state, true);
            
            document.getElementById('ai-planning').innerHTML =
              '<strong>âœ… AIæˆåŠŸï¼</strong><br/>è·ç‰©ãŒã‚´ãƒ¼ãƒ«ã«åˆ°é”ã—ã¾ã—ãŸï¼<br/>ã‚¹ãƒ†ãƒƒãƒ—æ•°: ' + state.step;
            
            // Auto retry if enabled
            if (autoRetry) {
              setTimeout(() => {
                console.log('ğŸ”„ æ¬¡ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’é–‹å§‹...');
                simulation.reset(currentLevel);
                simulation.start();
                episodeCount++;
                document.getElementById('episode-count').textContent = episodeCount;
                currentEpisodeReward = 0;
                actionHistory = [];
                episodeTransitioning = false;
                // Resume AI decision loop
                makeAIDecisionLoop();
              }, 2000);
            } else {
              episodeTransitioning = false;
              stopAIMode();
            }
          } else if (state.isFailure) {
            episodeTransitioning = true;
            
            // Clear existing AI loop to prevent overlap
            if (aiInterval) {
              clearTimeout(aiInterval);
              aiInterval = null;
            }
            
            // ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å®Œäº†ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€šçŸ¥
            await completeEpisode(state, false);
            
            document.getElementById('ai-planning').innerHTML =
              '<strong>âŒ AIå¤±æ•—...</strong><br/>è·ç‰©ãŒç”»é¢å¤–ã«è½ã¡ãŸã‹ã€æ™‚é–“åˆ‡ã‚Œã§ã™ã€‚';
            
            // Auto retry if enabled
            if (autoRetry) {
              setTimeout(() => {
                console.log('ğŸ”„ æ¬¡ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’é–‹å§‹...');
                simulation.reset(currentLevel);
                simulation.start();
                episodeCount++;
                document.getElementById('episode-count').textContent = episodeCount;
                currentEpisodeReward = 0;
                actionHistory = [];
                episodeTransitioning = false;
                // Resume AI decision loop
                makeAIDecisionLoop();
              }, 2000);
            } else {
              episodeTransitioning = false;
              stopAIMode();
            }
          }
        }
      }

      async function completeEpisode(state, success) {
        try {
          const response = await fetch('/api/world-model/episode-complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              level_key: currentLevel,
              state: state,
              actions_taken: actionHistory,
              reward: currentEpisodeReward,
            }),
          });

          if (response.ok) {
            const data = await response.json();
            console.log('ğŸ“š ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å®Œäº†:', data);
            
            if (data.key_insight) {
              console.log('ğŸ’¡ æ´å¯Ÿ:', data.key_insight);
            }
            if (data.reflection) {
              console.log('ğŸ§  ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³:', data.reflection);
              updateReflection(data.reflection);
            }
            
            await loadMemory();
          }
        } catch (error) {
          console.error('âŒ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // UI Update Functions
      function updateObservation(state) {
        const box = state.box.position;
        const goal = state.goal.position;
        const velocity = state.box.velocity;
        const dx = goal.x - box.x;
        const dy = goal.y - box.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const speed = Math.sqrt(velocity.x * velocity.x + velocity.y * velocity.y);
        
        document.getElementById('ai-observation').innerHTML = `
          <div><strong>è·ç‰©ä½ç½®:</strong> (${box.x.toFixed(0)}, ${box.y.toFixed(0)})</div>
          <div><strong>é€Ÿåº¦:</strong> ${speed.toFixed(2)} px/s</div>
          <div><strong>ã‚´ãƒ¼ãƒ«ã¾ã§:</strong> ${distance.toFixed(0)} px</div>
          <div><strong>ã‚¹ãƒ†ãƒƒãƒ—:</strong> ${state.step} / ${state.elapsedTime.toFixed(1)}s</div>
        `;
      }

      function updatePlanning(reasoning, action) {
        let actionText = action.type;
        if (action.type === 'push') {
          actionText += ` (åŠ›: ${action.forceX}, ${action.forceY}, æ™‚é–“: ${action.duration}ms)`;
        }
        
        document.getElementById('ai-planning').innerHTML = `
          <strong>ğŸ’­ æ¨è«–:</strong> ${reasoning}<br/><br/>
          <strong>ğŸ¬ è¡Œå‹•:</strong> ${actionText}<br/>
          <strong>ğŸ“ ç†ç”±:</strong> ${action.reason}
        `;
      }

      async function loadMemory() {
        try {
          const response = await fetch(`/api/world-model/memory?level_key=${currentLevel}`);
          if (response.ok) {
            const data = await response.json();
            
            if (data.recent_episodes && data.recent_episodes.length > 0) {
              let memoryHtml = '';
              for (const ep of data.recent_episodes.slice(-3)) {
                const icon = ep.success ? 'âœ…' : 'âŒ';
                memoryHtml += `<div class="memory-item">
                  ${icon} ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰${ep.episode_id}: ã‚¹ãƒ†ãƒƒãƒ—${ep.steps}, å ±é…¬${ep.reward.toFixed(0)}
                  ${ep.key_insight ? '<br/><small>ğŸ’¡ ' + ep.key_insight + '</small>' : ''}
                </div>`;
              }
              document.getElementById('ai-memory').innerHTML = memoryHtml;
            }
            
            if (data.reflection) {
              updateReflection(data.reflection);
            }
          }
        } catch (error) {
          console.error('âŒ ãƒ¡ãƒ¢ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      function updateReflection(reflection) {
        let reflectionHtml = `<div><strong>ãƒ‘ã‚¿ãƒ¼ãƒ³:</strong> ${reflection.pattern}</div>`;
        
        if (reflection.successful_strategy) {
          reflectionHtml += `<div><strong>âœ… æˆåŠŸæˆ¦ç•¥:</strong> ${reflection.successful_strategy}</div>`;
        }
        
        if (reflection.failed_attempts && reflection.failed_attempts.length > 0) {
          reflectionHtml += `<div><strong>âŒ å¤±æ•—ã‹ã‚‰å­¦ã¶:</strong></div>`;
          for (const attempt of reflection.failed_attempts.slice(-2)) {
            reflectionHtml += `<div style="margin-left: 10px;">â€¢ ${attempt}</div>`;
          }
        }
        
        reflectionHtml += `<div><strong>ğŸ’¡ æ”¹å–„ãƒ’ãƒ³ãƒˆ:</strong> ${reflection.improvement_hint}</div>`;
        
        document.getElementById('ai-reflection').innerHTML = reflectionHtml;
      }

      // AI Mode functions
      async function startAIMode() {
        if (!simulation) return;
        
        aiMode = true;
        actionHistory = [];
        episodeCount = 1;
        currentEpisodeReward = 0;
        episodeTransitioning = false;
        
        document.getElementById('btn-ai-mode').textContent = 'â¸ï¸ åœæ­¢';
        document.getElementById('btn-ai-mode').style.background = 'rgba(244, 67, 54, 0.6)';
        document.getElementById('episode-count').textContent = episodeCount;
        
        document.getElementById('ai-observation').innerHTML = 'ğŸ”„ çŠ¶æ…‹ã‚’è¦³å¯Ÿä¸­...';
        document.getElementById('ai-planning').innerHTML = '<strong>æ¨è«–:</strong> åˆæœŸåŒ–ä¸­...';
        
        if (!simulation.isRunning) {
          simulation.start();
        }
        
        await loadMemory();
        
        setTimeout(() => makeAIDecisionLoop(), 500);
      }

      function stopAIMode() {
        aiMode = false;
        episodeTransitioning = false;
        if (aiInterval) {
          clearTimeout(aiInterval);
          aiInterval = null;
        }
        isAIThinking = false;
        document.getElementById('btn-ai-mode').textContent = 'ğŸ¤– AIé–‹å§‹';
        document.getElementById('btn-ai-mode').style.background = '';
      }

      async function makeAIDecisionLoop() {
        if (!aiMode) return;
        
        await makeAIDecision();
        
        if (aiMode) {
          aiInterval = setTimeout(() => makeAIDecisionLoop(), 2000);
        }
      }

      async function makeAIDecision() {
        if (!simulation || !aiMode || isAIThinking) return;
        
        isAIThinking = true;
        
        const state = simulation.getState();
        
        updateObservation(state);
        
        let data = null;
        
        try {
          simulation.pauseTimer();
          
          document.getElementById('ai-planning').innerHTML = '<strong>æ¨è«–:</strong> ğŸ¤” AIæ€è€ƒä¸­...';
          
          const response = await fetch('/api/world-model/decide', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              level_key: currentLevel,
              state: state,
              step: state.step,
              previous_actions: actionHistory.slice(-10),
            }),
          });
          
          if (!response.ok) {
            throw new Error('API request failed');
          }
          
          data = await response.json();
          
          console.log('ğŸ“¦ Received action from backend:', data.action);
          
          updatePlanning(data.reasoning, data.action);
          
        } catch (error) {
          console.error('AI decision error:', error);
          document.getElementById('ai-planning').innerHTML = 
            '<strong>âŒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
          isAIThinking = false;
          stopAIMode();
        } finally {
          simulation.resumeTimer();
          
          isAIThinking = false;
          
          const finalState = simulation.getState();
          if (finalState.isSuccess || finalState.isFailure) {
            console.log('âš ï¸  Episode ended during AI thinking - skipping action execution');
            return;
          }
          
          if (data && aiMode) {
            console.log('ğŸ¯ Executing AI action:', data.action);
            simulation.executeAction(data.action);
            actionHistory.push(data.action.type);
          }
        }
      }

      function startStateUpdate() {
        if (updateInterval) clearInterval(updateInterval);
        updateInterval = setInterval(updateStateDisplay, 100);
      }

      function stopStateUpdate() {
        if (updateInterval) {
          clearInterval(updateInterval);
          updateInterval = null;
        }
      }

      // Initialize on load
      window.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
